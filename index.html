<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Carte des AOP/AOC</title>
  <link type="text/css" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" rel="Stylesheet" />   
  <script type="text/javascript" src="http://openlayers.org/api/OpenLayers.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
  <style type="text/css">
    #aboutbox pre {overflow-y:hidden;overflow-x:auto}
    .ui-front { z-index:1000; }
  </style>
</head>
<body>

  <div id="areaContainer" class="ui-widget ui-widget-content ui-corner-all">
    <input id="area" value="" type="text"></input>
    <a href="#" id="chooseArea">Choisir</a>
    <a id="openabout" href="#" target="blank">À propos</a>
    <span id="loading">Chargement des données …</span>
  </div>

  <div id="areasContainer">
    Aire : <input id="areaInput" value="" type="text" size="30"></input><br/>
    <div id="areaPropositions"></div>
  </div>
  <div id="map"></div>

  <div id="aboutbox">
    <p>Cette page permet d'afficher les communes des AOC/AOP. Les données <a href="https://www.data.gouv.fr/fr/dataset/aires-geographiques-des-aoc-aop">proviennent de l'Institut national de l'origine et de la qualité</a>.</p>
    <p>Le code source utilisé et les détails pour produire cette carte sont <a href="https://github.com/NicolasDumoulin/carte-AOP-AOC">disponible sous licence AGPL</a>.</div>
  
<script type="text/javascript">
  // map initialisation
  var lon = 2;
  var lat = 46;
  var zoom = 5;
  var aboutBox;
  var areaChooser;
  var map;
  var geojsonFormat;
  var aoslayer;
  function initMap() {
    map = new OpenLayers.Map ("map", {
      controls:[new OpenLayers.Control.Navigation(),
        new OpenLayers.Control.Permalink(),
        new OpenLayers.Control.PanZoom(),
        new OpenLayers.Control.MousePosition(),
        new OpenLayers.Control.LayerSwitcher(),
        new OpenLayers.Control.ScaleLine({geodesic:true}),
        new OpenLayers.Control.Attribution()],
      maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
      maxResolution: 156543.0399,
      numZoomLevels: 19,
      units: 'm',
      projection: new OpenLayers.Projection("EPSG:900913"),
      displayProjection: new OpenLayers.Projection("EPSG:4326")
    });
    map.addLayer(new OpenLayers.Layer.OSM("MapQuest", "http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png", {
      displayOutsideMaxExtent: true, isBaseLayer: true,
      'attribution': '<a href="http://www.openstreetmap.org" target="_blank">OpenStreetMap</a> - <a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>'
    }));
    geojsonFormat = new OpenLayers.Format.GeoJSON({
      internalProjection: new OpenLayers.Projection("EPSG:900913"),
      externalProjection: new OpenLayers.Projection("EPSG:4326")
    });
    aoslayer = new OpenLayers.Layer.Vector("Aires d'origines", {
      styleMap: new OpenLayers.StyleMap({
        default: OpenLayers.Util.applyDefaults({strokeColor: "#2E1EDC", fillOpacity: 0, strokeWidth:3},OpenLayers.Feature.Vector.style["default"]),
        select: OpenLayers.Util.applyDefaults({strokeColor: "#682697", strokeWidth: 3},OpenLayers.Feature.Vector.style["select"])
      })
    }); 
    map.addLayer(aoslayer);

    var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
    if (!map.getCenter()) {
      map.setCenter (lonLat, zoom);
      /*if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(position) {                
          map.setCenter(lonLat, 5);
        });
      }*/
    }
  }
  // init the list of "Appelations d'Origine" and build the dialog box for choosing one of them
  function initAOList() {
    $.getJSON('ao-json/index.txt', function(data) {
      for (var i = 0;i < data.length;i++) {
        $("#areaPropositions").append('<a href="#" class="areaProposition" ida='+data[i][2]+'>'+data[i][0]+"<br/></a>");
      }
      $('.areaProposition').hover(
        function(){ $(this).animate({paddingLeft: '+=10'}, 200); },
        function(){ $(this).animate({paddingLeft: '-=10'}, 200); }
      );
      // filtering in list of areas
      $("#areaInput").keyup(function(e){
        var filter = $(this).val();
        if (filter.length>2) {
          $(".areaProposition").each(function() {
            if($(this).text().toLowerCase().indexOf(filter.toLowerCase()) < 0) {
              $(this).fadeOut("fast");
            } else {
              $(this).fadeIn("fast");
            }
          });
        }
      });
      // action on area selection
      $(".areaProposition").click(function(){
        $("#area").val($(this).text());
        areaChooser.dialog('close');
        loadAO($(this).attr('ida'));
      });
      $("#loading").hide();
    })
  }
  function loadAO(idaFile) {
    $("#loading").show();
    $.getJSON(idaFile, function(data) {
      aoslayer.removeAllFeatures();
      aoslayer.addFeatures(geojsonFormat.read(data));
      map.zoomToExtent(aoslayer.getDataExtent())
      $("#loading").hide();
    });
  }
  
  function initEvents() {
    areaChooser = $("#areasContainer").dialog({autoOpen: false, title: 'Choisissez une aire', width:"auto", height: Math.min($(window).height()-15,600), zIndex:11000});
    $('#chooseArea').click(function() {
        areaChooser.dialog('open');
        return false;
      });
    aboutBox = $("#aboutbox").dialog({autoOpen:false, title:"À propos"});
    $('#openabout').click(function(){
      aboutBox.dialog('open');
      return false;
    });
  }
  $(document).ready(function(){
    $("#loading").show();
    initMap();
    initAOList();
    initEvents();
//     loadAO('ao-json/1269.json');
  })
</script>
